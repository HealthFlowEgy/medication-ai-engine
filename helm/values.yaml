# Egyptian AI Medication Validation Engine
# Helm Chart Values - Production Configuration
# Sprint 8: Production Hardening

# ===========================================
# Application Configuration
# ===========================================
app:
  name: medication-ai
  version: "1.0.0"
  environment: production

# ===========================================
# API Deployment
# ===========================================
api:
  replicaCount: 3
  
  image:
    repository: registry.digitalocean.com/healthflow/medication-ai
    tag: "1.0.0"
    pullPolicy: IfNotPresent
  
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 15
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  service:
    type: ClusterIP
    port: 8000
  
  env:
    LOG_LEVEL: "INFO"
    ENABLE_ARABIC_NLP: "true"
    ENABLE_ML_DDI: "true"
    ENABLE_METRICS: "true"
    WORKERS: "4"
  
  livenessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

# ===========================================
# Ingress Configuration
# ===========================================
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "1000"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: medication-ai.healthflow.eg
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: medication-ai-tls
      hosts:
        - medication-ai.healthflow.eg

# ===========================================
# PostgreSQL Configuration
# ===========================================
postgresql:
  enabled: true
  auth:
    username: medai
    database: medication_ai
    existingSecret: medication-ai-db-secret
  
  primary:
    persistence:
      enabled: true
      size: 20Gi
      storageClass: do-block-storage
    
    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
      limits:
        memory: "2Gi"
        cpu: "1000m"
  
  backup:
    enabled: true
    schedule: "0 2 * * *"  # Daily at 2 AM
    retention: 7

# ===========================================
# Redis Configuration  
# ===========================================
redis:
  enabled: true
  architecture: standalone
  
  auth:
    enabled: true
    existingSecret: medication-ai-redis-secret
  
  master:
    persistence:
      enabled: true
      size: 5Gi
      storageClass: do-block-storage
    
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"

# ===========================================
# Monitoring Stack
# ===========================================
monitoring:
  enabled: true
  
  prometheus:
    enabled: true
    retention: 15d
    storageSize: 20Gi
    
    scrapeInterval: 15s
    evaluationInterval: 15s
    
    alertmanager:
      enabled: true
  
  grafana:
    enabled: true
    adminPassword: ""  # Set via secret
    
    persistence:
      enabled: true
      size: 5Gi
    
    dashboards:
      default:
        medication-ai:
          gnetId: 0  # Custom dashboard
          revision: 1
          datasource: Prometheus

# ===========================================
# Security Configuration
# ===========================================
security:
  podSecurityPolicy:
    enabled: true
  
  networkPolicy:
    enabled: true
    ingress:
      - from:
          - namespaceSelector:
              matchLabels:
                name: ingress-nginx
    egress:
      - to:
          - namespaceSelector: {}
        ports:
          - port: 443
          - port: 5432
          - port: 6379
  
  serviceAccount:
    create: true
    annotations: {}

# ===========================================
# Secrets (Reference Only - Create Separately)
# ===========================================
secrets:
  # Create these secrets before deployment:
  # kubectl create secret generic medication-ai-db-secret \
  #   --from-literal=postgres-password=<password>
  #
  # kubectl create secret generic medication-ai-redis-secret \
  #   --from-literal=redis-password=<password>
  #
  # kubectl create secret generic medication-ai-api-secret \
  #   --from-literal=healthflow-api-key=<key> \
  #   --from-literal=jwt-secret=<secret>
  
  database: medication-ai-db-secret
  redis: medication-ai-redis-secret
  api: medication-ai-api-secret

# ===========================================
# Resource Quotas
# ===========================================
resourceQuota:
  enabled: true
  hard:
    requests.cpu: "8"
    requests.memory: "16Gi"
    limits.cpu: "16"
    limits.memory: "32Gi"
    pods: "50"

# ===========================================
# Node Affinity & Tolerations
# ===========================================
nodeSelector:
  workload: api

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - medication-ai
          topologyKey: kubernetes.io/hostname
