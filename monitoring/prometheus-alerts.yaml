# Egyptian AI Medication Validation Engine
# Prometheus Alerting Rules
# Sprint 8: Production Monitoring

groups:
  # ===========================================
  # API Health Alerts
  # ===========================================
  - name: medication-ai-api
    rules:
      - alert: MedicationAPIDown
        expr: up{job="medication-api"} == 0
        for: 1m
        labels:
          severity: critical
          team: healthflow
        annotations:
          summary: "Medication AI API is down"
          description: "The Medication AI API has been unreachable for more than 1 minute."
          runbook_url: "https://docs.healthflow.eg/runbooks/api-down"
      
      - alert: MedicationAPIHighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="medication-api"}[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "High API latency detected"
          description: "95th percentile latency is {{ $value | humanizeDuration }} (threshold: 500ms)"
      
      - alert: MedicationAPIHighErrorRate
        expr: rate(http_requests_total{job="medication-api", status=~"5.."}[5m]) / rate(http_requests_total{job="medication-api"}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          team: healthflow
        annotations:
          summary: "High error rate on Medication AI API"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
      
      - alert: MedicationAPIHighRequestRate
        expr: rate(http_requests_total{job="medication-api"}[1m]) > 1000
        for: 2m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "Unusually high request rate"
          description: "Request rate: {{ $value | humanize }}/sec. Possible attack or traffic spike."

  # ===========================================
  # Validation Performance Alerts
  # ===========================================
  - name: medication-ai-validation
    rules:
      - alert: ValidationLatencyHigh
        expr: histogram_quantile(0.95, rate(validation_duration_seconds_bucket[5m])) > 0.2
        for: 5m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "Prescription validation latency is high"
          description: "95th percentile validation time: {{ $value | humanizeDuration }} (target: 200ms)"
      
      - alert: MajorDDIRateHigh
        expr: rate(ddi_detections_total{severity="major"}[1h]) > 100
        for: 30m
        labels:
          severity: warning
          team: clinical
        annotations:
          summary: "High rate of major DDI detections"
          description: "{{ $value | humanize }} major DDIs detected per hour. May indicate data quality issue."
      
      - alert: ValidationFailureRateHigh
        expr: rate(validation_failures_total[5m]) / rate(validation_requests_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          team: healthflow
        annotations:
          summary: "High validation failure rate"
          description: "{{ $value | humanizePercentage }} of validations are failing"

  # ===========================================
  # Database Alerts
  # ===========================================
  - name: medication-ai-database
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          team: healthflow
        annotations:
          summary: "PostgreSQL database is down"
          description: "The PostgreSQL database has been unreachable for more than 1 minute."
      
      - alert: PostgreSQLHighConnections
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "PostgreSQL connection pool nearly exhausted"
          description: "{{ $value | humanizePercentage }} of max connections in use"
      
      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_statements_seconds_total[5m]) / rate(pg_stat_statements_calls_total[5m]) > 1
        for: 10m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "PostgreSQL slow queries detected"
          description: "Average query time: {{ $value | humanizeDuration }}"

  # ===========================================
  # Redis Cache Alerts
  # ===========================================
  - name: medication-ai-redis
    rules:
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          team: healthflow
        annotations:
          summary: "Redis cache is down"
          description: "Redis has been unreachable for more than 1 minute."
      
      - alert: RedisCacheHitRateLow
        expr: redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total) < 0.8
        for: 15m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "Redis cache hit rate is low"
          description: "Cache hit rate: {{ $value | humanizePercentage }} (expected: >80%)"
      
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "Redis memory usage is high"
          description: "Memory usage: {{ $value | humanizePercentage }}"

  # ===========================================
  # Resource Alerts
  # ===========================================
  - name: medication-ai-resources
    rules:
      - alert: PodCPUHigh
        expr: rate(container_cpu_usage_seconds_total{namespace="medication-ai"}[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "Pod CPU usage is high"
          description: "Pod {{ $labels.pod }} CPU: {{ $value | humanizePercentage }}"
      
      - alert: PodMemoryHigh
        expr: container_memory_usage_bytes{namespace="medication-ai"} / container_spec_memory_limit_bytes > 0.85
        for: 5m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "Pod memory usage is high"
          description: "Pod {{ $labels.pod }} memory: {{ $value | humanizePercentage }}"
      
      - alert: PodRestartingTooMuch
        expr: increase(kube_pod_container_status_restarts_total{namespace="medication-ai"}[1h]) > 3
        for: 5m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "Pod restarting frequently"
          description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last hour"
      
      - alert: PVCStorageAlmostFull
        expr: kubelet_volume_stats_used_bytes{namespace="medication-ai"} / kubelet_volume_stats_capacity_bytes > 0.85
        for: 10m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "Persistent volume almost full"
          description: "PVC {{ $labels.persistentvolumeclaim }} is {{ $value | humanizePercentage }} full"

  # ===========================================
  # HealthFlow Integration Alerts
  # ===========================================
  - name: medication-ai-integration
    rules:
      - alert: HealthFlowWebhookFailures
        expr: rate(webhook_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          team: healthflow
        annotations:
          summary: "HealthFlow webhook deliveries failing"
          description: "{{ $value | humanize }} webhook failures per second"
      
      - alert: HealthFlowIntegrationDown
        expr: healthflow_integration_status != 1
        for: 2m
        labels:
          severity: critical
          team: healthflow
        annotations:
          summary: "HealthFlow integration is down"
          description: "Unable to communicate with HealthFlow Unified System"

  # ===========================================
  # Clinical Safety Alerts
  # ===========================================
  - name: medication-ai-clinical
    rules:
      - alert: BlockedPrescriptionRateHigh
        expr: rate(prescriptions_blocked_total[1h]) / rate(prescriptions_validated_total[1h]) > 0.1
        for: 1h
        labels:
          severity: warning
          team: clinical
        annotations:
          summary: "High prescription blocking rate"
          description: "{{ $value | humanizePercentage }} of prescriptions are being blocked. Review may be needed."
      
      - alert: ContraindicationMissed
        expr: increase(contraindication_false_negatives_total[24h]) > 0
        for: 1m
        labels:
          severity: critical
          team: clinical
        annotations:
          summary: "CRITICAL: Contraindication may have been missed"
          description: "A contraindication was detected after prescription was approved. Immediate review required."
